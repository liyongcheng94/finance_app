# 报销处理功能说明

## 功能概述

完整的报销处理功能已经成功实现，可以处理报销 Excel 文件并生成符合财务系统导入要求的会计分录文件。

## 主要功能

### 1. 数据解析

- **顶部信息解析**: 自动识别日期、报销人、银行信息、银行代码、摘要等关键信息
- **明细数据解析**: 解析每条报销明细的报销人、部门代码、项目、费用类型、费用代码、金额等
- **数据验证**: 自动检查数据完整性，对缺失或错误的部门+项目字段给出警告

### 2. 会计分录生成

- **借方分录**: 为每个费用项目生成借方分录，记录到对应的费用科目
- **贷方分录**: 为银行支付生成贷方分录，从对应的银行账户扣减
- **自动平衡**: 确保借贷平衡，总借方金额等于总贷方金额

### 3. Excel 文件输出

- **标准格式**: 生成符合财务系统导入要求的 Excel 文件
- **双工作表**: 包含 t_Schema 配置表和 Page1 数据表
- **完整字段**: 包含所有必需的会计分录字段（FDate、FAccountNum、FAmountFor 等）

## 支持的文件格式

### 输入文件要求

- Excel 文件(.xlsx 格式)
- 包含"报销 (每日)"工作表
- 数据结构：
  ```
  第1行: 日期、报销人、银行等基本信息
  第3行: 表头行
  第4行起: 明细数据
  ```

### 明细数据列结构

- 列 A: 报销人
- 列 B: 部门代码
- 列 C: 项目简称
- 列 D: 备注
- 列 E: 费用别称
- 列 G: 费用代码
- 列 H: 金额
- 列 I: 摘要
- 列 J: 部门+项目

## 使用方法

### Web 界面操作

1. 访问 http://127.0.0.1:8000/
2. 选择"报销处理"
3. 上传符合要求的报销 Excel 文件
4. 点击"处理文件"
5. 下载生成的会计分录 Excel 文件

### API 接口

```python
from finance_app.services.excel_processor import ExcelProcessor

processor = ExcelProcessor()
output_path, record_count = processor.process_excel_file(
    file_path="报销文件.xlsx",
    process_type="reimbursement"
)
```

## 处理逻辑

### 1. 按报销人分组

系统会自动按报销人对明细进行分组处理，每个报销人生成一组完整的会计分录。

### 2. 会计分录规则

- **费用明细**: 借记对应费用科目，金额为实际报销金额
- **银行支付**: 贷记对应银行科目，金额为该报销人的总报销金额

### 3. 数据校验

- 检查必要字段是否完整
- 验证金额格式是否正确
- 确保日期格式符合要求
- 对部门+项目字段错误给出警告但不中断处理

## 输出示例

生成的 Excel 文件包含以下格式的会计分录：

| FDate      | FAccountNum | FAccountName  | FDebit | FCredit  | FExplanation         |
| ---------- | ----------- | ------------- | ------ | -------- | -------------------- |
| 2025-05-28 | 5101.10     | 运输费用      | 466.7  | 0        | 祁剑波报销：运输费用 |
| 2025-05-28 | 1002.16     | 东莞银行 8387 | 0      | 16025.12 | 祁剑波报销总计       |

## 技术特性

- **高性能**: 支持大批量数据处理
- **容错性**: 对数据格式错误有良好的容错处理
- **日志记录**: 详细的处理日志，便于问题排查
- **模块化**: 代码结构清晰，易于维护和扩展

## 版本信息

- 版本: 1.0.0
- 更新日期: 2025-08-03
- 开发状态: ✅ 完成并通过测试

## 测试结果

✅ 数据解析正确  
✅ 会计分录生成正确  
✅ 借贷平衡验证通过  
✅ Excel 文件输出正常  
✅ Web 界面集成成功

## 注意事项

1. 确保输入文件的"部门+项目"列公式计算正确
2. 如果出现#N/A 或公式错误，系统会记录警告但继续处理
3. 建议在处理大文件前先用小样本测试
4. 输出文件会自动按时间戳命名，避免文件冲突
