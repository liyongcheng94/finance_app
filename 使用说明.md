# 🚀 Django 财务 Excel 处理系统

## 🎯 项目概述

这是一个基于 Django 的 Web 应用，将您原来的 Excel 处理脚本改造为现代化的 API 服务。主要功能包括：

- ✅ **文件上传**: 支持拖拽上传 Excel 文件
- ✅ **自动处理**: 后台自动解析和生成财务数据
- ✅ **实时反馈**: 显示处理进度和详细日志
- ✅ **文件下载**: 一键下载处理结果
- ✅ **历史记录**: 查看所有处理历史
- ✅ **REST API**: 提供完整的 API 接口

## 🔧 环境要求

- Python 3.8+
- Windows 10/11

## 📦 安装步骤

### 方法一：使用启动脚本（推荐）

1. 双击运行 `start.bat` 文件
2. 脚本会自动安装依赖、初始化数据库并启动服务
3. 访问 http://127.0.0.1:8000/

### 方法二：手动安装

1. **安装依赖包**

```bash
cd django_finance_app
pip install -r requirements.txt
```

2. **初始化数据库**

```bash
python manage.py makemigrations
python manage.py migrate
```

3. **启动服务器**

```bash
python manage.py runserver
```

4. **访问应用**

- 主页: http://127.0.0.1:8000/
- 历史记录: http://127.0.0.1:8000/history/

## 🖥️ 界面功能

### 主页面 (/)

- **文件上传区域**: 支持拖拽或点击上传 Excel 文件
- **处理进度**: 实时显示文件处理状态
- **结果下载**: 处理完成后可直接下载结果文件
- **错误提示**: 详细的错误信息和解决建议

### 历史记录页面 (/history/)

- **记录列表**: 显示所有处理历史
- **状态过滤**: 按处理状态筛选记录
- **日期筛选**: 按日期范围查询
- **日志查看**: 查看每次处理的详细日志
- **文件下载**: 重新下载历史结果文件

## 🔌 API 接口

### 基础 URL

```
http://127.0.0.1:8000/api/finance/
```

### 主要端点

#### 1. 文件上传处理

```http
POST /api/finance/records/upload/
Content-Type: multipart/form-data

Body:
- file: Excel文件

Response:
{
  "id": 1,
  "status": "completed",
  "message": "文件处理成功，共处理 10 条记录",
  "total_records": 10,
  "processing_time": 2.34
}
```

#### 2. 获取历史记录

```http
GET /api/finance/records/

Response:
{
  "count": 100,
  "results": [
    {
      "id": 1,
      "filename": "排单.xlsx",
      "upload_time_display": "2025-08-02 14:30:22",
      "status": "completed",
      "total_records": 10
    }
  ]
}
```

#### 3. 下载结果文件

```http
GET /api/finance/records/{id}/download/

Response: 文件下载
```

#### 4. 获取处理日志

```http
GET /api/finance/records/{id}/logs/

Response:
[
  {
    "timestamp_display": "2025-08-02 14:30:22",
    "level": "INFO",
    "message": "文件处理完成"
  }
]
```

## 📁 文件结构

原始 Excel 文件需要包含以下工作表：

- `付款(每日)`: 主要付款数据
- `核算项目_供应商`: 供应商信息
- `核算项目_项目`: 项目信息
- `核算项目_费用代码`: 费用类型代码

## ⚠️ 注意事项

1. **文件格式**: 仅支持 .xlsx 和 .xls 格式
2. **文件大小**: 最大支持 50MB
3. **工作表名称**: 必须与原始脚本中的名称一致
4. **数据格式**: 保持与原始 Excel 模板相同的列结构

## 🐛 故障排除

### 常见问题

**Q: 启动时提示"ModuleNotFoundError"**
A: 运行 `pip install -r requirements.txt` 安装依赖包

**Q: 文件上传失败**
A: 检查文件格式是否为 Excel，大小是否超过 50MB

**Q: 处理失败显示"找不到供应商/项目"**
A: 检查 Excel 文件中的供应商和项目数据是否完整

**Q: 端口 8000 被占用**
A: 使用 `python manage.py runserver 8001` 更换端口

### 查看日志

- 应用日志: `finance_app.log`
- 处理日志: 通过 Web 界面的"查看日志"功能

## 🔄 从原始脚本迁移

### 优势对比

| 功能     | 原始脚本   | Django 版本 |
| -------- | ---------- | ----------- |
| 文件选择 | 文件对话框 | 拖拽上传    |
| 错误处理 | 弹窗提示   | 详细日志    |
| 历史记录 | 无         | 完整历史    |
| 远程访问 | 无         | Web 界面    |
| API 支持 | 无         | RESTful API |
| 并发处理 | 无         | 支持多用户  |

### 迁移步骤

1. 备份原始脚本和数据
2. 测试 Django 版本的处理结果
3. 确认输出格式一致
4. 切换到 Django 版本

## 📞 技术支持

如遇到技术问题，请：

1. 查看错误日志
2. 检查文件格式和内容
3. 尝试重新启动服务
4. 联系技术支持团队

---

🎉 **恭喜！您的 Excel 处理系统已成功升级为现代化的 Web 应用！**
