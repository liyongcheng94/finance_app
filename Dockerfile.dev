# 开发环境Dockerfile
FROM python:3.11-slim

# 设置工作目录
WORKDIR /app

# 设置环境变量
ENV PYTHONDONTWRITEBYTECODE=1 \
  PYTHONUNBUFFERED=1 \
  PYTHONPATH=/app \
  DJANGO_SETTINGS_MODULE=finance_project.settings

# 安装系统依赖
RUN apt-get update && apt-get install -y \
  build-essential \
  libpq-dev \
  curl \
  && rm -rf /var/lib/apt/lists/*

# 复制requirements文件
COPY django_finance_app/requirements.txt .

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt

# 安装开发依赖
RUN pip install --no-cache-dir \
  django-debug-toolbar \
  ipython \
  black \
  flake8

# 复制项目文件
COPY django_finance_app/ .

# 创建必要的目录
RUN mkdir -p media/uploads media/outputs static logs

# 设置权限
RUN chmod -R 755 media static logs

# 暴露端口
EXPOSE 8000

# 开发环境启动脚本
RUN echo '#!/bin/bash\n\
  echo "开始启动 Finance App (开发环境)..."\n\
  echo "等待数据库连接..."\n\
  sleep 5\n\
  echo "运行数据库迁移..."\n\
  python manage.py migrate\n\
  echo "创建超级用户（如果不存在）..."\n\
  python manage.py shell -c "from django.contrib.auth.models import User; User.objects.filter(username=\"admin\").exists() or User.objects.create_superuser(\"admin\", \"admin@example.com\", \"admin123\")" || echo "超级用户已存在"\n\
  echo "启动Django开发服务器..."\n\
  python manage.py runserver 0.0.0.0:8000' > /app/start-dev.sh

RUN chmod +x /app/start-dev.sh

# 启动命令
CMD ["/app/start-dev.sh"]
